# Chess Game Integration Flow - Current Implementation

This document describes the complete flow of two players starting a chess game from the platform frontend, integrating with the chess game service, and how data flows between services.

## Quick Summary

### ✅ What's Implemented
1. **Game Registration**: Platform frontend → API Gateway → Platform Backend → RabbitMQ ✅
2. **Game Creation**: Chess frontend → Chess backend → RabbitMQ ✅
3. **Move Handling**: Chess frontend → Chess backend → RabbitMQ ✅
4. **Event Consumption**: Platform Backend ACL adapter consumes all chess events ✅
5. **Event Transformation**: ACL adapter transforms chess events to platform format ✅
6. **Event Logging**: Transformed events republished to game_events for game-service logging ✅

### ✅ Fixed Issues
1. **Achievement Awarding**: ✅ Now awards achievements to players via GameContextPort
2. **Player ID Lookup**: ✅ Improved error handling - events still published even if lookup fails
3. **Event Handling**: ✅ All chess events are properly consumed and transformed

### ⚠️ Remaining Gaps (Require Frontend/External Service Changes)
1. **Lobby System**: No lobby integration for chess (players connect directly) ⚠️
   - **Solution**: Modify frontend to create lobby first, then start game when lobby has 2 players
   - **Requires**: Frontend changes to integrate lobby creation flow
2. **Player Authentication**: Chess backend sends player names, not platform user IDs ⚠️
   - **Current**: ACL adapter looks up player IDs by name (works if players exist)
   - **Solution**: Modify chess backend to accept and send user IDs, or store mapping during registration
   - **Requires**: External chess backend changes or mapping storage

## Overview

Chess is an **external game** with its own frontend (React) and backend (Spring Boot). The platform integrates with it via:
- **API Gateway ACL**: Transforms requests/responses between platform format and chess service format
- **RabbitMQ Events**: Asynchronous communication for game events
- **Platform Backend ACL Adapter**: Consumes chess events, transforms them, and republishes for logging

## Complete Flow: Two Players Starting a Chess Game

### Phase 1: Game Registration (Single Player Initiates)

```
┌─────────────┐
│   Player 1  │
│  (Frontend) │
└──────┬──────┘
       │ 1. Clicks "Play Now" on Chess game
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│         Platform Frontend (React)                       │
│  - GameLibrary.tsx: handlePlayGame()                   │
│  - Generates tempGameId (UUID)                         │
│  - Calls chessService.registerGame()                   │
└──────┬──────────────────────────────────────────────────┘
       │ 2. POST /api/external/chess/register
       │    Body: { frontendUrl, pictureUrl }
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              API Gateway (Port 8080)                    │
│                                                         │
│  Route: platform-backend-chess-register                │
│  - Path: /api/platform/register/**                     │
│  - Rewrites: /api/platform/register/{gameId}           │
│              → /api/external/chess/register/{gameId}   │
│  - GenerateGameIdFilter: Generates UUID gameId         │
│  - Public endpoint (no auth required)                  │
└──────┬──────────────────────────────────────────────────┘
       │ 3. POST /api/external/chess/register/{gameId}
       │    (gameId generated by gateway)
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│         Platform Backend (Port 8081)                   │
│                                                         │
│  ChessGameController.registerChessGame()               │
│  - Receives gameId and registration request            │
│  - Generates registrationId (UUID)                     │
│  - Creates ChessGameRegisteredMessage with:            │
│    * registrationId                                    │
│    * frontendUrl                                       │
│    * pictureUrl                                        │
│    * availableAchievements (8 chess achievements)      │
│  - Publishes to RabbitMQ:                             │
│    Exchange: gameExchange                              │
│    Routing Key: game.registered                        │
└──────┬──────────────────────────────────────────────────┘
       │ 4. RabbitMQ Message: GameRegisteredMessage
       │    Routing Key: game.registered
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              RabbitMQ (Port 5672)                       │
│                                                         │
│  Exchange: gameExchange (topic)                        │
│  Routing Key: game.registered                           │
│                                                         │
│  Message Content:                                       │
│  {                                                     │
│    "registrationId": "uuid",                          │
│    "frontendUrl": "http://localhost:3333/game/{gameId}",│
│    "pictureUrl": "...",                                │
│    "availableAchievements": [...],                     │
│    "messageType": "GAME_REGISTERED",                   │
│    "timestamp": "..."                                  │
│  }                                                     │
└──────┬──────────────────────────────────────────────────┘
       │
       │ 5. Response to Frontend
       │    { success: true, gameId: "...", ... }
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│         Platform Frontend                               │
│  - Receives response with gameId                        │
│  - Redirects to: http://localhost:3333/game/{gameId}    │
└─────────────────────────────────────────────────────────┘
```

**Current Status**: ✅ **IMPLEMENTED**
- Platform frontend registers chess game
- API Gateway generates gameId
- Platform Backend publishes GameRegisteredMessage
- Frontend redirects to chess frontend

---

### Phase 2: Chess Frontend - Game Creation with Two Players

```
┌─────────────────────────────────────────────────────────┐
│         Chess Frontend (React, Port 3333)              │
│                                                         │
│  Route: /game/{gameId}                                 │
│  - Player 1 lands on chess game page                    │
│  - Chess frontend needs to create game with 2 players   │
│  - Calls chess backend to create game                   │
└──────┬──────────────────────────────────────────────────┘
       │ 6. POST /api/games/{gameId}
       │    Body: {
       │      "whitePlayerId": "player1-uuid",
       │      "whitePlayerName": "Player 1",
       │      "blackPlayerId": "player2-uuid",
       │      "blackPlayerName": "Player 2"
       │    }
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              API Gateway (Port 8080)                    │
│                                                         │
│  Route: chess-game-direct-games                         │
│  - Path: /api/games/**                                 │
│  - Directly forwards to chess backend                   │
│  - No ACL transformation (direct routing)               │
└──────┬──────────────────────────────────────────────────┘
       │ 7. POST /api/games/{gameId}
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│         Chess Backend (Spring Boot, Port 8080)         │
│                                                         │
│  GameController.createGame()                            │
│  - Creates chess game in PostgreSQL                    │
│  - Initializes board state (FEN)                       │
│  - Sets status: ACTIVE                                 │
│  - Publishes to RabbitMQ:                              │
│    Exchange: gameExchange                              │
│    Routing Key: game.created                           │
│                                                         │
│  GameCreatedMessage:                                   │
│  {                                                     │
│    "gameId": "uuid",                                  │
│    "whitePlayer": "Player 1",                          │
│    "blackPlayer": "Player 2",                          │
│    "currentFen": "rnbqkbnr/pppppppp/8/8/8/8/...",     │
│    "status": "ACTIVE",                                 │
│    "messageType": "GAME_CREATED",                      │
│    "timestamp": "..."                                  │
│  }                                                     │
└──────┬──────────────────────────────────────────────────┘
       │ 8. RabbitMQ Message: GameCreatedMessage
       │    Routing Key: game.created
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              RabbitMQ                                   │
│  Exchange: gameExchange                                 │
│  Routing Key: game.created                              │
└─────────────────────────────────────────────────────────┘
```

**Current Status**: ⚠️ **PARTIALLY IMPLEMENTED**
- Chess backend can create games ✅
- Chess backend publishes GameCreatedMessage ✅
- **GAP**: No consumer for GameCreatedMessage in platform backend
- **GAP**: No lobby system integration for chess (players connect directly)

---

### Phase 3: Making Moves

```
┌─────────────────────────────────────────────────────────┐
│         Chess Frontend                                  │
│  - Player makes a move (e.g., e2-e4)                   │
│  - Calls chess backend to make move                     │
└──────┬──────────────────────────────────────────────────┘
       │ 9. POST /api/moves/{gameId}
       │    Body: { from: "e2", to: "e4", ... }
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              API Gateway                                │
│  Route: chess-game-direct-moves                         │
│  - Path: /api/moves/**                                │
│  - Directly forwards to chess backend                   │
└──────┬──────────────────────────────────────────────────┘
       │ 10. POST /api/moves/{gameId}
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│         Chess Backend                                   │
│  MoveController.makeMove()                               │
│  - Validates move                                       │
│  - Updates game state (FEN)                            │
│  - Publishes to RabbitMQ:                              │
│    Exchange: gameExchange                              │
│    Routing Key: move.made                              │
│                                                         │
│  MoveMadeMessage:                                      │
│  {                                                     │
│    "gameId": "uuid",                                  │
│    "fromSquare": "e2",                                 │
│    "toSquare": "e4",                                   │
│    "sanNotation": "e4",                                │
│    "fenAfterMove": "...",                              │
│    "player": "WHITE",                                  │
│    "moveNumber": 1,                                    │
│    "messageType": "MOVE_MADE",                         │
│    "timestamp": "..."                                   │
│  }                                                     │
└──────┬──────────────────────────────────────────────────┘
       │ 11. RabbitMQ Message: MoveMadeMessage
       │     Routing Key: move.made
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              RabbitMQ                                   │
│  Exchange: gameExchange                                 │
│  Routing Key: move.made                                 │
└─────────────────────────────────────────────────────────┘
```

**Current Status**: ✅ **IMPLEMENTED**
- Chess backend handles moves ✅
- Publishes MoveMadeMessage ✅
- **GAP**: No consumer for MoveMadeMessage in platform backend

---

### Phase 4: Event Consumption

#### 4.1 Game Service Consumer

```
┌─────────────────────────────────────────────────────────┐
│         Game Service Consumer                          │
│  (game-service-consumer container)                      │
│                                                         │
│  Consumes from RabbitMQ:                               │
│  - game.session.start.requested                         │
│  - game.session.started                                │
│  - game.move.response                                  │
│                                                         │
│  Note: Currently does NOT consume chess events          │
│  (game.created, move.made, game.registered)            │
└─────────────────────────────────────────────────────────┘
```

**Current Status**: ⚠️ **NOT CONFIGURED FOR CHESS**
- Game Service Consumer exists ✅
- Consumes game.session.* events ✅
- **GAP**: Does not consume chess-specific events

#### 4.2 Platform Backend Consumers

```
┌─────────────────────────────────────────────────────────┐
│         Platform Backend                               │
│                                                         │
│  ChessGameACLAdapter (ACL Pattern)                     │
│  - @RabbitListener on chess.game.created               │
│  - @RabbitListener on chess.move.made                  │
│  - @RabbitListener on chess.game.registered            │
│  - @RabbitListener on chess.game.ended                  │
│  - @RabbitListener on chess.achievement.acquired        │
│                                                         │
│  Responsibilities:                                     │
│  1. Transform chess events to platform format          │
│  2. Find player IDs from player names                  │
│  3. Republish to game_events exchange for logging      │
│  4. Register achievements (TODO: not fully implemented)│
│                                                         │
│  Note: Does NOT manage chess game state                │
│  (Chess backend owns all game state)                   │
└─────────────────────────────────────────────────────────┘
```

**Current Status**: ✅ **IMPLEMENTED**
- Platform Backend consumes all chess events ✅
- Transforms and republishes for logging ✅
- **GAP**: Achievement registration is logged but not fully implemented
- **GAP**: Player ID lookup by name may fail if player doesn't exist

---

## Current Implementation Gaps

### 1. **No Lobby System for Chess**
- Chess games are created directly by the chess frontend
- No integration with platform's lobby system
- Players must coordinate outside the platform (e.g., share gameId)

### 2. **Event Consumers (✅ Implemented)**
- **GameCreatedMessage**: ✅ Consumed by ChessGameACLAdapter
- **MoveMadeMessage**: ✅ Consumed by ChessGameACLAdapter
- **GameRegisteredMessage**: ✅ Consumed by ChessGameACLAdapter
- **AchievementAcquiredMessage**: ✅ Consumed by ChessGameACLAdapter
- **GAP**: Achievement registration is logged but not fully implemented (TODO in code)

### 3. **No Game Session Creation**
- Chess games are managed entirely by chess backend
- Game Service does not create sessions for chess
- No `game.session.start.requested` event for chess

### 4. **No Player ID Integration**
- Chess frontend uses player names, not platform user IDs
- No mapping between platform users and chess players
- No authentication/authorization for chess moves

### 5. **Achievement Tracking (⚠️ Partial)**
- Achievements are defined in GameRegisteredMessage ✅
- ChessGameACLAdapter consumes AchievementAcquiredMessage ✅
- Transforms and republishes to game_events ✅
- **GAP**: Achievement registration has TODO comment (not fully implemented)
- **GAP**: No integration with platform achievement system to award achievements

---

## Data Flow Summary

### Registration Flow (✅ Implemented)
```
Platform Frontend → API Gateway → Platform Backend → RabbitMQ (game.registered)
```

### Game Creation Flow (✅ Implemented)
```
Chess Frontend → API Gateway → Chess Backend → RabbitMQ (game.created)
                                                      ↓
                                              ✅ Platform Backend ACL Adapter
                                              - Transforms to platform format
                                              - Republishes to game_events (game.session.started)
                                              - Game Logger consumes for logging
```

### Move Flow (✅ Implemented)
```
Chess Frontend → API Gateway → Chess Backend → RabbitMQ (move.made)
                                                      ↓
                                              ✅ Platform Backend ACL Adapter
                                              - Transforms to platform format
                                              - Republishes to game_events (game.move.request)
                                              - Game Logger consumes for logging
```

### Event Consumption (✅ Implemented)
```
RabbitMQ (game.created, move.made, game.registered)
    ↓
✅ Platform Backend: ChessGameACLAdapter
   - Consumes: game.created, move.made, game.registered, game.ended, achievement.acquired
   - Transforms events to platform format
   - Republishes to game_events exchange for logging
```

**Note**: The ACL adapter transforms chess events but does NOT manage chess game state. Chess backend owns all game state.

---

## What Needs to Be Implemented

### 1. **Lobby Integration for Chess**
- Create lobby in platform backend
- When lobby starts, trigger chess game creation
- Map platform user IDs to chess player IDs

### 2. **Event Consumers in Platform Backend**
- **GameCreatedMessage Consumer**: Store game metadata
- **MoveMadeMessage Consumer**: Track moves, check achievements
- **AchievementAcquiredMessage Consumer**: Award achievements to players

### 3. **Game Service Integration**
- Optionally consume chess events for logging/analytics
- Do NOT manage chess game state (chess backend owns it)

### 4. **Player Authentication**
- Pass platform user IDs to chess backend
- Chess backend should validate player identity
- Map platform users to chess players

### 5. **Achievement System Integration**
- When chess backend publishes AchievementAcquiredMessage
- Platform backend should award achievement to player
- Update player's achievement list

---

## API Endpoints Summary

### Platform Frontend → Platform Backend
- `POST /api/external/chess/register/{gameId}` - Register chess game ✅

### Chess Frontend → Chess Backend (via Gateway)
- `POST /api/games/{gameId}` - Create game with 2 players ✅
- `GET /api/games/{gameId}` - Get game state ✅
- `PUT /api/games/{gameId}` - Update player names ✅
- `POST /api/moves/{gameId}` - Make a move ✅
- `PATCH /api/games/{gameId}/mate` - End game (checkmate) ✅
- `PATCH /api/games/{gameId}/draw` - End game (draw) ✅

### Chess Backend → Platform Backend
- `POST /api/platform/register/{gameId}` - Register game ✅

---

## RabbitMQ Events Summary

| Event | Publisher | Routing Key | Consumer | Status |
|-------|-----------|-------------|----------|--------|
| `GameRegisteredMessage` | Platform Backend | `game.registered` | ✅ Platform Backend ACL | Consumed & transformed |
| `GameCreatedMessage` | Chess Backend | `game.created` | ✅ Platform Backend ACL | Consumed & transformed |
| `MoveMadeMessage` | Chess Backend | `move.made` | ✅ Platform Backend ACL | Consumed & transformed |
| `GameEndedMessage` | Chess Backend | `game.ended` | ✅ Platform Backend ACL | Consumed & transformed |
| `AchievementAcquiredMessage` | Chess Backend | `achievement.acquired` | ✅ Platform Backend ACL | Consumed & transformed |

---

## Next Steps

1. **Implement lobby system for chess** - Allow players to create/join chess lobbies
2. **Add event consumers** - Platform Backend should consume chess events
3. **Integrate achievements** - Award achievements when chess backend publishes events
4. **Player authentication** - Pass platform user IDs to chess backend
5. **Game session tracking** - Optionally track chess games in game-service for analytics

