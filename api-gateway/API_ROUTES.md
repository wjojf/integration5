# API Gateway Routes Documentation

This document describes all routes available through the API Gateway.

## Route Structure

All routes are prefixed with `/api` and require authentication (JWT token) unless otherwise specified.

## Platform Backend Routes

**Base Path**: `/api/platform/**`

Routes to: `platform-backend:8081`

### Available Endpoints
- `/api/platform/lobbies/**` - Lobby management
- `/api/platform/friends/**` - Friends system
- `/api/platform/achievements/**` - Achievements system
- `/api/platform/games/**` - Game registry

**Rate Limit**: 100 req/s, burst 200

## Game Service Routes

**Base Path**: `/api/v1/games/**`

Routes to: `game-service:8000`

### Games Module
- `GET /api/v1/games/games` - List available games
- `POST /api/v1/games/games/create` - Create a new game (stateless)
- `POST /api/v1/games/games/move` - Apply a move (stateless)
- `POST /api/v1/games/games/legal-moves` - Get legal moves
- `POST /api/v1/games/games/evaluate` - Evaluate game state

### Sessions Module
- `POST /api/v1/games/sessions` - Create a new game session
- `GET /api/v1/games/sessions/{session_id}` - Get session by ID
- `POST /api/v1/games/sessions/{session_id}/moves` - Apply move to session

### Chatbot Module
- `POST /api/v1/chatbot/chat` - Send chat message
- `GET /api/v1/chatbot/conversation/{conversation_id}` - Get conversation history
- `GET /api/v1/chatbot/health` - Chatbot health check

**Rate Limit**: 50 req/s, burst 100

### AI Player Module
- `POST /api/v1/games/ai-player/move` - Get AI move recommendation
- `POST /api/v1/games/ai-player/adjust-difficulty` - Adjust AI difficulty
- `GET /api/v1/games/ai-player/levels` - Get available difficulty levels

**Rate Limit**: 100 req/s, burst 200

### ML Models Module
- `GET /api/v1/games/ml/health` - Health check
- `GET /api/v1/games/ml/status` - Model status
- `POST /api/v1/games/ml/train/policy` - Train policy model
- `POST /api/v1/games/ml/train/winprob` - Train win probability model
- `POST /api/v1/games/ml/train/all` - Train both models
- `POST /api/v1/games/ml/load` - Load saved models
- `POST /api/v1/games/ml/predict/move` - Predict best move
- `POST /api/v1/games/ml/predict/winprob` - Predict win probability
- `POST /api/v1/games/ml/predict/all` - Get both predictions

**Rate Limit**: 50 req/s, burst 100

### Game Logger Module
- `POST /api/v1/games/game-logger/log-move` - Log a game move
- `POST /api/v1/games/game-logger/create-session` - Create logging session
- `POST /api/v1/games/game-logger/finish-session` - Finish logging session
- `GET /api/v1/games/game-logger/game/{game_id}/logs` - Get game logs
- `GET /api/v1/games/game-logger/player/{player_id}/logs` - Get player logs
- `POST /api/v1/games/game-logger/export-dataset` - Export dataset to parquet
- `GET /api/v1/games/game-logger/dataset-stats` - Get dataset statistics
- `POST /api/v1/games/game-logger/dvc/init` - Initialize DVC
- `POST /api/v1/games/game-logger/dvc/push/{version}` - Push dataset to DVC

**Rate Limit**: 100 req/s, burst 200

### Health & Documentation
- `GET /api/v1/games/health` - Health check (public)
- `GET /api/v1/games/docs` - Swagger UI (public)
- `GET /api/v1/games/redoc` - ReDoc UI (public)
- `GET /api/v1/games/openapi.json` - OpenAPI JSON (public)

**Rate Limit**: No rate limiting for health/docs endpoints

## External Games Routes

**Base Path**: `/api/external/**`

Routes to: `platform-backend:8081` with ACL transformation

### Chess Game Routes

**Base Path**: `/api/external/chess/**`

- `POST /api/external/chess/register` - Register chess game with platform
  - **Note**: gameId is generated by the gateway (UUID) according to platform rules
  - **Request Body**:
    ```json
    {
      "frontendUrl": "http://localhost:3333/game/abc123",
      "pictureUrl": "https://..."
    }
    ```
  - **Flow**:
    1. Gateway generates gameId (UUID)
    2. Gateway transforms request and calls external chess service: `POST /api/platform/register/{gameId}`
    3. External chess service processes registration and publishes `game.registered` event
    4. Platform backend consumes event and stores metadata
  - **Response**: Registration confirmation with registrationId and generated gameId

- `GET /api/external/chess/games/{gameId}` - Get chess game information

### Generic External Games Routes

- `POST /api/external/games/{id}/events` - Submit external game event

**ACL Transformation**: 
- Chess game events are automatically detected and transformed
- Generic external game events are transformed using default mapping
- All events are transformed to platform event format

## Gateway Documentation Routes

**Base Path**: `/api/docs/**` (Public)

### Available Endpoints
- `GET /api/docs/swagger-ui.html` - Swagger UI
- `GET /api/docs/openapi.json` - Gateway OpenAPI spec
- `GET /api/docs/aggregate` - Aggregated docs from all services

## Public Endpoints

These endpoints don't require authentication:

- `/actuator/**` - Spring Boot Actuator
- `/health` - Gateway health check
- `/fallback/**` - Circuit breaker fallbacks
- `/api/docs/**` - API documentation
- `/api/external/**` - External game integration

## Authentication

All other endpoints require a valid JWT token in the Authorization header:

```http
Authorization: Bearer <jwt-token>
```

The gateway validates the token with Keycloak and adds user information to request headers:
- `X-User-Id`: User ID
- `X-Username`: Username
- `X-User-Roles`: Comma-separated roles

## Service-to-Service Communication

Internal services communicate using API keys:

```http
X-API-Key: <service-api-key>
X-Service-Name: <service-name>
```

## Examples

### Create Game Session
```bash
curl -X POST http://localhost:8080/api/v1/games/sessions \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "session-123",
    "game_id": "game-456",
    "game_type": "connect_four",
    "player_ids": ["player1", "player2"],
    "starting_player_id": "player1"
  }'
```

### Chatbot Query
```bash
curl -X POST http://localhost:8080/api/v1/games/chatbot/chat \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "What are the rules of Connect Four?",
    "user_id": "user-123"
  }'
```

### Get AI Move
```bash
curl -X POST http://localhost:8080/api/v1/games/ai-player/move \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "game_state": {...},
    "player_level": "medium"
  }'
```

## Error Responses

### 401 Unauthorized
```json
{
  "error": "Unauthorized",
  "message": "Missing or invalid JWT token"
}
```

### 429 Too Many Requests
```json
{
  "error": "Too Many Requests",
  "message": "Rate limit exceeded",
  "retryAfter": 30
}
```

### 503 Service Unavailable
```json
{
  "error": "Service Unavailable",
  "service": "game-service",
  "message": "Service temporarily unavailable",
  "timestamp": "2024-01-01T12:00:00Z",
  "retryAfter": 30
}
```
